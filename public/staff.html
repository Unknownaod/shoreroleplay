<!DOCTYPE html>
<html lang="en">
<head>
  <title>Shore Roleplay | Staff Control Console</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#05070a url('https://i.imgur.com/vbt5BPF.jpeg') center/cover fixed;
  color:#fff;
  font-family:"Segoe UI",sans-serif;
  overflow-x:hidden;
}

/* NAV */
nav{
  padding:18px 55px;
  display:flex;justify-content:space-between;align-items:center;
  background:rgba(0,0,0,.35);backdrop-filter:blur(18px);
  border-bottom:1px solid rgba(255,255,255,.12);
  position:fixed;top:0;width:100%;z-index:1000;
}
nav a{
  color:#dbe6ff;text-decoration:none;font-size:15px;margin-right:32px;
  transition:.25s;letter-spacing:.4px;
}
nav a:hover{color:#4ea3ff;text-shadow:0 0 12px #4ea3ff}

.user-controls{
  display:flex;gap:12px;align-items:center;
  font-size:14px;
}
.user-btn{
  padding:6px 14px;border-radius:4px;border:1px solid rgba(255,255,255,.28);
  background:rgba(255,255,255,.05);color:#fff;font-weight:500;
  cursor:pointer;transition:.25s;
}
.user-btn:hover{background:rgba(255,255,255,.18)}
.logout-btn{background:#4ea3ff;border-color:#4ea3ff}
.logout-btn:hover{filter:brightness(1.07)}

/* HEADER */
header{padding-top:135px;text-align:center;}
header h1{
  font-size:3.4rem;font-weight:700;margin-bottom:10px;
  text-shadow:0 0 26px rgba(78,163,255,.45);
}
header p{opacity:.75;font-size:1.1rem}

/* LOGIN */
.login-box{
  max-width:450px;margin:80px auto;background:rgba(10,14,22,.78);
  padding:38px;border-radius:14px;
  border:1px solid rgba(255,255,255,.1);
  backdrop-filter:blur(28px);text-align:center;
  box-shadow:0 0 35px rgba(0,0,0,.55);
}
.login-box input{
  width:100%;padding:15px;font-size:16px;
  border-radius:10px;border:1px solid rgba(255,255,255,.22);
  background:#0e121c;color:#fff;margin-top:16px;transition:.25s;
}
.login-box button{
  margin-top:22px;width:100%;padding:15px;
  background:#4ea3ff;border:none;border-radius:10px;
  color:#fff;font-size:17px;font-weight:600;
  transition:.25s;cursor:pointer;letter-spacing:.4px;
}
.login-box button:hover{transform:translateY(-3px) scale(1.03);box-shadow:0 0 22px #4ea3ff}

/* PANEL */
.panel{
  display:none;max-width:1350px;margin:60px auto;
  background:rgba(5,8,14,.75);
  padding:40px;border-radius:14px;
  border:1px solid rgba(255,255,255,.07);
  backdrop-filter:blur(22px);
  box-shadow:0 0 45px rgba(0,0,0,.65);
  animation:fadeIn .45s ease forwards;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(30px)}to{opacity:1}}

/* CONTROLS */
.tabs{display:flex;gap:12px;margin-bottom:18px}
.tab{
  padding:10px 18px;border-radius:8px;
  background:#111820;border:1px solid rgba(255,255,255,.12);
  cursor:pointer;transition:.25s;font-size:14px;
}
.tab.active,.tab:hover{background:#4ea3ff;border-color:#4ea3ff}

/* TABLE SHARED */
table{width:100%;border-collapse:collapse;margin-top:25px}
th,td{padding:12px 10px;text-align:left;border-bottom:1px solid rgba(255,255,255,.09);font-size:14px}
th{text-transform:uppercase;font-size:12px;letter-spacing:.8px;color:#4ea3ff;opacity:.9}

/* STATUS */
.status{
  padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;text-transform:uppercase;
}
.pending{background:#f1c40f33;color:#f1c40f}
.accepted{background:#2ecc7133;color:#2ecc71}
.denied{background:#e74c3c33;color:#e74c3c}

/* BUTTONS */
.btn{
  padding:6px 10px;border-radius:6px;font-size:12px;cursor:pointer;border:none;transition:.2s;font-weight:600;margin:1px 0;
}
.accept{background:#2ecc71;border:1px solid #1e9d55}
.accept:hover{background:#45ed8a}
.deny{background:#e74c3c;border:1px solid #b23127}
.deny:hover{background:#ff6a5e}
.view{background:#2980b9;border:1px solid #1f5f86;color:#fff}
.view:hover{background:#3498db}
.delete{background:#6c63ff;border:1px solid #5148cc}
.delete:hover{background:#857dff}
.neutral{background:#7f8c8d;border:1px solid #707b7c}
.neutral:hover{background:#95a5a6}

/* ROLE BADGES IN TABLE */
.role-badge{
  padding:4px 8px;border-radius:999px;font-size:11px;font-weight:600;display:inline-block;
}
.role-user{background:#4ea3ff22;border:1px solid #4ea3ff}
.role-ha{background:#ff3b3b33;border:1px solid #ff7979;color:#ffb3b3}
.role-ia{background:#ffd00033;border:1px solid #ffd000;color:#ffd000}
.role-admin{background:#4ea3ff33;border:1px solid #4ea3ff;color:#dbe9ff}
.role-junior-admin{background:#8e44ad33;border:1px solid #9b59b6;color:#e8d9ff}
.role-senior-staff{background:#16a08533;border:1px solid #1abc9c;color:#a9fff2}
.role-staff{background:#2980b933;border:1px solid #3498db;color:#d6ecff}
.role-sit{background:#f39c1233;border:1px solid #f39c12;color:#ffe8c0}

/* ROLE SELECT DROPDOWN */
.role-select{
  width:100%;
  background:#111820;
  border:1px solid rgba(255,255,255,.25);
  color:#fff;
  padding:4px 6px;
  border-radius:6px;
  font-size:12px;
  margin-bottom:6px;
}

/* MODAL */
#modal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.65);
  display:none;justify-content:center;align-items:center;z-index:2000;
}
.modal-box{
  background:#0b0f16;padding:35px;width:550px;max-height:85vh;
  overflow-y:auto;border-radius:12px;border:1px solid rgba(255,255,255,.12);
}
.modal-box h3{margin-bottom:14px}
.modal-close{
  margin-top:18px;padding:10px 18px;border-radius:8px;
  background:#4ea3ff;border:none;color:#fff;cursor:pointer;
}

footer{text-align:center;margin-top:65px;opacity:.45;font-size:.85rem}
</style>
</head>
<body>

<nav>
  <div>
    <a href="index.html">Home</a>
    <span style="opacity:.55;">Staff Panel</span>
  </div>

  <!-- USER LOGIN STATE -->
  <div id="userControls" class="user-controls"></div>
</nav>

<header>
  <h1>Staff Operations Console</h1>
  <p>Staff Credentials Required</p>
</header>

<!-- LOGIN -->
<div id="loginBox" class="login-box">
  <h2>Authorization Required</h2>
  <input id="staffPass" type="password" placeholder="Staff Access Password">
  <button onclick="login()">Access Console</button>
  <p id="error" style="color:#e74c3c;margin-top:12px;"></p>
</div>

<!-- PANEL -->
<div id="panel" class="panel">
  <h2 style="margin-bottom:18px;font-weight:600;color:#4ea3ff">Application Review Dashboard</h2>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('pending')">Pending Applications</div>
    <div class="tab" onclick="switchTab('all')">Previous Applications</div>
    <div class="tab" onclick="switchTab('forums')">Forum Tools</div>
    <div class="tab" onclick="switchTab('ha')">HA Tab (Head Administration)</div>
    <div class="tab" id="appealsTab" onclick="switchTab('appeals')" style="display:none;">
      Ban Appeals
    </div>
  </div>

  <!-- APPLICATIONS SECTION -->
  <div id="appsSection">
    <table>
      <thead>
        <tr>
          <th>USERNAME</th>
          <th>EMAIL</th>
          <th>DEPARTMENT</th>
          <th>SUBMITTED</th>
          <th>STATUS</th>
          <th>ACTION</th>
        </tr>
      </thead>
      <tbody id="apps"></tbody>
    </table>
  </div>

  <!-- FORUM MODERATION -->
  <div id="forumsSection" style="display:none;">
    <h2 class="section-title">Forum Moderation Panel</h2>
    <p style="opacity:.7;margin-bottom:18px;font-size:14px;">
      View users and perform forum-related moderation actions.
    </p>

    <table>
      <thead>
        <tr>
          <th>USERNAME</th>
          <th>EMAIL</th>
          <th>ROLE</th>
          <th>POSTING STATUS</th>
          <th>ACTIONS</th>
        </tr>
      </thead>
      <tbody id="forumUsers"></tbody>
    </table>
  </div>

  <!-- HA / USERS SECTION -->
  <div id="haSection" style="display:none;margin-top:10px;">
    <h3 style="margin-bottom:10px;">User Management (HA Only)</h3>
    <p style="font-size:13px;opacity:.8;margin-bottom:8px;">
      View all registered accounts. HWID and last login IP can be used for manual bans on other systems.
    </p>
    <table>
      <thead>
        <tr>
          <th>USERNAME</th>
          <th>EMAIL</th>
          <th>ROLE</th>
          <th>BANNED</th>
          <th>HWID</th>
          <th>LAST IP</th>
          <th>CREATED</th>
          <th>LAST LOGIN</th>
          <th>ACTIONS</th>
        </tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>
  </div>
</div>

<!-- BAN APPEALS SECTION -->
<div id="appealsSection" style="display:none;margin-top:35px;">

  <div style="
    background:rgba(5,8,14,.78);
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px;
    padding:35px 38px;
    backdrop-filter:blur(22px);
    box-shadow:0 0 45px rgba(0,0,0,.55);
    animation:fadeIn .45s ease forwards;
  ">

    <h2 style="
      margin-bottom:8px;
      font-weight:600;
      font-size:1.6rem;
      color:#4ea3ff;
      text-shadow:0 0 18px rgba(78,163,255,.45);
    ">
      Ban Appeals
    </h2>

    <p style="opacity:.65;margin-bottom:18px;font-size:14px;">
      Review user ban appeals. Only Head Administration may approve, deny, or delete appeals.
    </p>

    <table style="width:100%;border-collapse:collapse;margin-top:10px;">
      <thead>
        <tr>
          <th>USERNAME</th>
          <th>EMAIL</th>
          <th>APPEAL REASON</th>
          <th>SUBMITTED</th>
          <th>STATUS</th>
          <th>ACTIONS</th>
        </tr>
      </thead>
      <tbody id="appealsBody"></tbody>
    </table>

  </div>
</div>


<!-- MODAL -->
<div id="modal">
  <div class="modal-box">
    <h3 id="modalTitle"></h3>
    <pre id="modalContent" style="white-space:pre-wrap;font-size:14px;opacity:.9"></pre>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<footer>¬© Shore Roleplay</footer>

<script>
<script>
const API = "https://shoreroleplay.onrender.com";
let currentTab = 'pending';
let haUnlocked = false;

/* Allowed staff roles for HA role editor */
const ROLE_OPTIONS = [
  "User",
  "Staff In Training",
  "Staff",
  "Senior Staff",
  "Junior Administration",
  "Administration",
  "Internal Affairs",
  "Head Administrator"
];

/* ========== LOAD USER SESSION ========== */
const user = JSON.parse(localStorage.getItem("shoreUser"));
const box = document.getElementById("userControls");

/* ---------- STAFF ROLE ENFORCEMENT GATE ---------- */
const STAFF_ROLES = [
  "Staff In Training",
  "Staff",
  "Senior Staff",
  "Junior Administration",
  "Administration",
  "Internal Affairs",
  "Head Administrator"
];

if (!user || !STAFF_ROLES.includes(user.role)) {
  alert("üö´ Staff role required.");
  location.href = "index.html";
  throw new Error("Unauthorized access");
}

/* ---------- USER NAV DISPLAY ---------- */
if (!user) {
  box.innerHTML = `
    <button class="user-btn" onclick="location.href='login.html'">Login</button>
    <button class="user-btn logout-btn" onclick="location.href='register.html'">Register</button>
  `;
} else {
  box.innerHTML = `
    Logged in as <strong>${user.username}</strong>
    <button class="user-btn" onclick="location.href='profile.html?user=${encodeURIComponent(user.username)}'">Profile</button>
    <button class="user-btn" onclick="location.href='settings.html'">Settings</button>
    <button class="user-btn logout-btn" onclick="logout()">Logout</button>
  `;
}

function logout(){
  localStorage.removeItem("shoreUser");
  location.reload();
}

/* ---------- STAFF PASSWORD LOGIN PROMPT ---------- */
document.getElementById("loginBox").style.display = "block";

/* STAFF AUTH ‚Üí /staff-auth */
async function login(){
  const password = document.getElementById("staffPass").value.trim();
  const res = await fetch(API + "/staff-auth", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ password })
  });

  if(res.ok){
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("panel").style.display = "block";

    // Only HA sees the Ban Appeals tab
    if (user && user.role === "Head Administrator") {
      document.getElementById("appealsTab").style.display = "inline-block";
    }

    loadApps();
  } else {
    document.getElementById("error").textContent = "‚ùå Invalid Credential";
  }
}

/* ========== TABS ========== */
function switchTab(tab){
  currentTab = tab;

  // Highlight correct tab
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelector(`.tab:nth-child(${
    tab==='pending' ? 1 :
    tab==='all' ? 2 :
    tab==='forums' ? 3 :
    tab==='ha' ? 4 : 5
  })`).classList.add("active");

  const appsSection    = document.getElementById("appsSection");
  const forumsSection  = document.getElementById("forumsSection");
  const haSection      = document.getElementById("haSection");
  const appealsSection = document.getElementById("appealsSection");

  appsSection.style.display    = (tab === "pending" || tab === "all") ? "block" : "none";
  forumsSection.style.display  = (tab === "forums") ? "block" : "none";
  haSection.style.display      = (tab === "ha") ? "block" : "none";
  appealsSection.style.display = (tab === "appeals") ? "block" : "none";

  if(tab === "ha"){
    if(!haUnlocked) haPrompt();
    else loadUsers();
  }
  else if(tab === "forums"){
    loadForumUsers();
  }
  else if(tab === "appeals"){
    if(!user || user.role !== "Head Administrator"){
      alert("üö´ Only Head Administration may review appeals.");
      switchTab("pending");
      return;
    }
    loadAppeals();
  }
  else {
    loadApps();
  }
}

/* ========== HA PASSWORD PROMPT ‚Üí /ha-auth ========== */
async function haPrompt(){
  const pwd = prompt("Enter HA (Head Administration) password:");
  if(!pwd){
    currentTab = "pending";
    switchTab("pending");
    return;
  }

  const res = await fetch(API + "/ha-auth", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ password: pwd })
  });

  if(res.ok){
    haUnlocked = true;
    loadUsers();
  } else {
    alert("Invalid HA password.");
    currentTab = "pending";
    switchTab("pending");
  }
}

/* ========== APPEALS ========== */

async function loadAppeals(){
  const res = await fetch(API + "/appeals");
  if(!res.ok){
    document.getElementById("appealsBody").innerHTML =
      `<tr><td colspan="6" style="opacity:.6;">Failed to load appeals.</td></tr>`;
    return;
  }

  const appeals = await res.json();
  const tbody = document.getElementById("appealsBody");

  tbody.innerHTML = appeals.length ? appeals.map(a => `
    <tr>
      <td>${a.username}</td>
      <td>${a.email || "‚Äî"}</td>
      <td>${a.reason}</td>
      <td>${new Date(a.createdAt || a.submittedAt).toLocaleDateString()}</td>
      <td><span class="status ${a.status}">${a.status}</span></td>
      <td>
        <button class="btn view"   onclick="viewAppeal('${a.id}')">View</button>
        <button class="btn accept" onclick="decideAppeal('${a.id}','accepted')">Accept</button>
        <button class="btn deny"   onclick="decideAppeal('${a.id}','denied')">Deny</button>
        <button class="btn delete" onclick="deleteAppeal('${a.id}')">Delete</button>
      </td>
    </tr>
  `).join("") : `<tr><td colspan="6" style="opacity:.6;">No appeals submitted.</td></tr>`;
}

/* View full appeal in modal */
async function viewAppeal(id){
  const res = await fetch(API + "/appeals");
  if(!res.ok) return;

  const appeals = await res.json();
  const a = appeals.find(x => x.id === id);
  if(!a) return;

  document.getElementById("modalTitle").textContent = `Ban Appeal ‚Äî ${a.username}`;
  document.getElementById("modalContent").textContent =
`ID: ${a.id}
Username: ${a.username}
Email: ${a.email || "‚Äî"}
Status: ${a.status}
Submitted: ${a.createdAt || a.submittedAt}

Reason:
${a.reason || "No reason provided"}
`;
  document.getElementById("modal").style.display = "flex";
}

/* Accept / Deny appeal */
async function decideAppeal(id, status){
  if(!confirm(`Mark this appeal as ${status.toUpperCase()}?`)) return;

  const res = await fetch(`${API}/appeals/${id}/decision`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ status })
  });

  if(res.ok){
    if(status === "accepted"){
      await fetch(`${API}/appeals/${id}/unban`, { method:"POST" });
    }
    alert("Decision saved.");
    loadAppeals();
  }else{
    alert("Failed to save decision.");
  }
}

/* Delete appeal */
async function deleteAppeal(id){
  if(!confirm("‚ùå Permanently delete this appeal?")) return;

  const res = await fetch(`${API}/appeals/${id}`, { method:"DELETE" });
  if(res.ok){
    alert("Appeal deleted.");
    loadAppeals();
  } else {
    alert("Failed to delete appeal.");
  }
}

/* ========== APPLICATIONS ========== */
async function loadApps(){
  const res = await fetch(API + "/applications");
  if(!res.ok){
    document.getElementById("apps").innerHTML =
      `<tr><td colspan="6">Failed to load applications.</td></tr>`;
    return;
  }

  const data = await res.json();
  const pending = data.filter(a => a.status === "pending");
  const set = currentTab === "pending" ? pending : data;

  document.getElementById("apps").innerHTML = set.map(app => `
    <tr>
      <td>${app.username}</td>
      <td>${app.email}</td>
      <td>${app.department}</td>
      <td>${app.submittedAt ? app.submittedAt.split("T")[0] : ""}</td>
      <td><span class="status ${app.status}">${app.status}</span></td>
      <td>
        <button class="btn view"   onclick="viewApp('${app.id}')">View</button>
        <button class="btn accept" onclick="decide('${app.id}','accepted')">Accept</button>
        <button class="btn deny"   onclick="decide('${app.id}','denied')">Deny</button>
        <button class="btn delete" onclick="removeApp('${app.id}')">Delete</button>
      </td>
    </tr>
  `).join("") || `<tr><td colspan="6" style="opacity:.7;">No applications in this view.</td></tr>`;
}

/* VIEW FULL APPLICATION (client-side filter on /applications) */
async function viewApp(id){
  const apps = await (await fetch(API + "/applications")).json();
  const app = apps.find(a => a.id === id);
  if(!app) return;

  document.getElementById("modalTitle").textContent = `Application ‚Äî ${app.username}`;
  document.getElementById("modalContent").textContent =
`ID: ${app.id}
Username: ${app.username}
Email: ${app.email}
Department: ${app.department}
Status: ${app.status}
Submitted: ${app.submittedAt}

Reason:
${app.reason || "No reason provided"}

Logging Agreement: ${app.agreedLogging ? "YES" : "NO"}
Discord Requirement: ${app.agreedDiscord ? "YES" : "NO"}
`;
  document.getElementById("modal").style.display = "flex";
}

function closeModal(){
  document.getElementById("modal").style.display = "none";
}

/* DECISION ‚Üí /applications/:id/decision */
async function decide(id, status){
  if(!confirm(`Confirm marking this application as ${status.toUpperCase()}?`)) return;

  // Optional reason prompt
  const reason = prompt("Reason for this decision (optional):") || "";

  const res = await fetch(`${API}/applications/${id}/decision`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      decision: status, // <-- status is already "accepted" or "denied"
      reason: reason
    })
  });

  const data = await res.json();

  if(res.ok){
    alert(`Application ${status}.`);
    loadApps(); // refresh
  } else {
    alert("Failed to update decision: " + (data.error || "Unknown error"));
  }
}


/* DELETE APPLICATION ‚Üí /applications/:id */
async function removeApp(appId, element) {
  const user = JSON.parse(localStorage.getItem("shoreUser"));
  if (!user) return alert("Not logged in");

  if (!confirm("Are you sure you want to delete this application?")) return;

  const res = await fetch(`${API}/applications/${appId}`, {
    method: "DELETE",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId: user.id })
  });

  const data = await res.json();
  if (!data.success) {
    return alert(data.error || "Failed to delete application.");
  }

  // üî• Remove it from the UI instantly ‚Äî NO PAGE RELOAD
  element.remove();
}



/* ========== HA / USERS SECTION ========== */

/* Map backend role strings to nice colored badges */
function renderRoleBadge(roleRaw){
  const role = (roleRaw || "User").trim();

  let cls = "role-user";
  let label = role;

  if(role === "Head Administrator" || role === "HA"){ cls = "role-ha"; label = "Head Administrator"; }
  else if(role === "Internal Affairs"){ cls = "role-ia"; }
  else if(role === "Administration"){ cls = "role-admin"; }
  else if(role === "Junior Administration"){ cls = "role-junior-admin"; }
  else if(role === "Senior Staff"){ cls = "role-senior-staff"; }
  else if(role === "Staff" || role.toLowerCase() === "staff"){ cls = "role-staff"; label = "Staff"; }
  else if(role === "Staff In Training"){ cls = "role-sit"; }
  else if(role.toLowerCase() === "user"){ cls = "role-user"; label = "User"; }

  return `<span class="role-badge ${cls}">${label}</span>`;
}

/* Build the role dropdown for HA tab */
function buildRoleSelect(roleRaw, userId){
  let current = (roleRaw || "User").trim();

  if(current === "HA") current = "Head Administrator";
  else if(current.toLowerCase() === "staff") current = "Staff";
  else if(current.toLowerCase() === "user") current = "User";

  const optionsHtml = ROLE_OPTIONS.map(r => {
    const selected = (current.toLowerCase() === r.toLowerCase()) ? "selected" : "";
    return `<option value="${r}" ${selected}>${r}</option>`;
  }).join("");

  return `
    <select id="role-${userId}" class="role-select">
      ${optionsHtml}
    </select>
  `;
}

/* Change a user's role via /users/:id/role */
async function changeUserRole(id, role){
  if(!confirm(`Set this user's role to "${role}"?`)) return;

  try{
    const res = await fetch(`${API}/users/${id}/role`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ role })
    });

    if(res.ok){
      alert("Role updated.");
      loadUsers();
    }else{
      alert("Failed to update role.");
    }
  }catch(err){
    console.error("Role update error:", err);
    alert("Error updating role.");
  }
}

/* GET ALL USERS ‚Üí /users */
async function loadUsers(){
  const res = await fetch(API + "/users");
  const body = document.getElementById("usersBody");

  if(!res.ok){
    body.innerHTML = `<tr><td colspan="9" style="opacity:.7;">Failed to load users.</td></tr>`;
    return;
  }

  const users = await res.json();
  if(!Array.isArray(users) || users.length === 0){
    body.innerHTML = `<tr><td colspan="9" style="opacity:.7;font-size:13px;">No users found.</td></tr>`;
    return;
  }

  body.innerHTML = users.map(u => `
    <tr>
      <td>${u.username}</td>
      <td>${u.email}</td>
      <td>${renderRoleBadge(u.role)}</td>
      <td>${u.banned ? "YES" : "NO"}</td>
      <td>${u.hwid || "‚Äî"}</td>
      <td>${u.lastIP || "‚Äî"}</td>
      <td>${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : "‚Äî"}</td>
      <td>${u.lastLoginAt ? new Date(u.lastLoginAt).toLocaleString() : "‚Äî"}</td>
      <td>
        ${buildRoleSelect(u.role, u.id)}
        <button class="btn neutral" onclick="changeUserRole('${u.id}', document.getElementById('role-${u.id}').value)">Set Role</button><br>
        <button class="btn deny"   onclick="banUser('${u.id}')">Ban</button>
        <button class="btn accept" onclick="unbanUser('${u.id}')">Unban</button>
        <button class="btn delete" onclick="deleteUser('${u.id}')">Delete</button>
        <button class="btn view"   onclick="copyHwid('${u.hwid || ""}')">Copy HWID</button>
      </td>
    </tr>
  `).join("");
}

/* BAN / UNBAN / DELETE ‚Üí /users/:id/ban, /users/:id/unban, DELETE /users/:id */
async function banUser(id){
  if(!confirm("Ban this user?")) return;
  const res = await fetch(`${API}/users/${id}/ban`, { method:"POST" });
  if(res.ok){
    alert("User banned.");
    loadUsers();
  }else{
    alert("Ban failed.");
  }
}

async function unbanUser(id){
  if(!confirm("Unban this user?")) return;
  const res = await fetch(`${API}/users/${id}/unban`, { method:"POST" });
  if(res.ok){
    alert("User unbanned.");
    loadUsers();
  }else{
    alert("Unban failed.");
  }
}

async function deleteUser(id){
  if(!confirm("Delete this user and all of their applications?")) return;
  const res = await fetch(`${API}/users/${id}`, { method:"DELETE" });
  if(res.ok){
    alert("User deleted.");
    loadUsers();
  }else{
    alert("Delete failed.");
  }
}

/* COPY HWID */
function copyHwid(hwid){
  if(!hwid){
    alert("No HWID for this user.");
    return;
  }
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(hwid).then(
      () => alert("HWID copied to clipboard."),
      () => alert("Failed to copy HWID.")
    );
  }else{
    alert("Clipboard API not available.");
  }
}

/* ========== FORUM USER MODERATION ========== */
async function loadForumUsers(){
  try {
    const res = await fetch(`${API}/users`);
    const users = await res.json();

    const staffRole = user?.role || "User";
    const isHA = staffRole === "Head Administrator";

    const tbody = document.getElementById("forumUsers");
    tbody.innerHTML = "";

    users.forEach(u => {
      const isTargetHA = u.role === "Head Administrator";

      tbody.innerHTML += `
        <tr>
          <td>${u.username}</td>
          <td>${u.email}</td>
          <td>${u.role || "User"}</td>
          <td style="color:${u.restricted ? "red" : "lime"};">
            ${u.restricted ? "Restricted" : "Allowed to Post"}
          </td>
          <td>
            <button class="btn deny" onclick="toggleRestrict('${u.id}', ${!!u.restricted}, '${u.role}')">
              ${u.restricted ? "Unrestrict" : "Restrict Posting"}
            </button>

            ${isHA && !isTargetHA ? `
              <button class="btn delete" onclick="banUser('${u.id}')">
                Ban User
              </button>
            ` : ""}

            <button class="btn view" onclick="location.href='profile.html?user=${u.username}'">
              View Profile
            </button>
          </td>
        </tr>
      `;
    });
  } catch (err) {
    console.error("Forum users failed to load:", err);
    document.getElementById("forumUsers").innerHTML =
      `<tr><td colspan="5" style="color:red;">Failed to load forum users.</td></tr>`;
  }
}

async function toggleRestrict(id, current, targetRole){
  const staffRole = user?.role || "User";

  const protectedRanks = [
    "Junior Administration",
    "Administration",
    "Internal Affairs",
    "Head Administrator"
  ];

  if (protectedRanks.includes(targetRole) && staffRole !== "Head Administrator") {
    alert("‚ùå Only Head Administration may restrict Junior Administration or higher.");
    return;
  }

  if(!confirm(`Are you sure you want to ${current ? "UNRESTRICT" : "RESTRICT"} this user from posting?`)) return;

  await fetch(`${API}/users/${id}/restrict`, {
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      userId: user.id,
      restricted: !current
    })
  });

  loadForumUsers();
}
</script>

</body>
</html>
