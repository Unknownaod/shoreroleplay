<!DOCTYPE html>
<html lang="en">
<head>
<title>Shore Roleplay | Account Settings</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
:root {
  --accent:#4ea3ff;
  --bg:#000000c7;
  --card:#0c111a;
  --text:#fff;
}
[data-theme="light"] {
  --bg:#e8ecf6;
  --card:#ffffff;
  --text:#000;
  --accent:#2c6ae8;
}
body{
  font-family:"Inter",sans-serif;
  background:url("https://i.imgur.com/vbt5BPF.jpeg") center/cover fixed;
  color:var(--text);overflow-x:hidden;
  transition:.3s;
}
nav{
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(18px);
  border-bottom:1px solid rgba(255,255,255,.12);
  padding:18px 60px;
  display:flex;justify-content:space-between;align-items:center;
  position:fixed;top:0;width:100%;z-index:20;
}
nav .nav-left a{
  margin-right:28px;font-size:15px;opacity:.85;color:#dbe6ff;
}
nav .nav-left a:hover{
  color:var(--accent);text-shadow:0 0 10px var(--accent);
}
.nav-right{display:flex;align-items:center;gap:14px}
button.btn{
  background:var(--accent);padding:8px 16px;border-radius:8px;
  border:none;color:#fff;font-weight:600;cursor:pointer;
  box-shadow:0 0 12px rgba(78,163,255,.4);
}

/* MAIN */
main{
  max-width:1100px;margin:140px auto 60px;
  background:var(--bg);border-radius:14px;
  border:1px solid rgba(255,255,255,.1);
  box-shadow:0 0 45px rgba(0,0,0,.6);padding:40px;
}
h1{font-size:2.6rem;margin-bottom:4px}
.sub{opacity:.75;margin-bottom:18px;font-size:1.05rem}

/* PROFILE PICTURE */
.pfp-box{
  text-align:center;margin-bottom:30px;
}
#pfp{
  width:120px;height:120px;border-radius:14px;
  border:2px solid var(--accent);
  object-fit:cover;box-shadow:0 0 16px rgba(0,0,0,.6);
}
.upload-box{
  margin-top:12px;
  display:flex;gap:10px;justify-content:center;
}
.upload-input{
  width:65%;padding:12px;border-radius:8px;
  border:1px solid rgba(255,255,255,.25);
  background:var(--card);color:var(--text);
}
button.upload-btn{
  padding:12px 20px;border:none;border-radius:8px;
  background:var(--accent);color:white;font-weight:600;
  cursor:pointer;
}

/* SECTIONS */
.section{margin-top:45px}
.section h2{
  font-size:1.45rem;margin-bottom:14px;
  border-left:4px solid var(--accent);padding-left:10px;
}
.card{
  background:var(--card);border-radius:10px;
  border:1px solid rgba(255,255,255,.12);
  padding:18px;margin:8px 0;font-size:.95rem;
}

/* INPUTS */
input{
  width:100%;padding:14px;border-radius:8px;
  border:1px solid rgba(255,255,255,.2);
  background:var(--card);color:var(--text);margin-top:6px;
}

/* BUTTONS */
button.action{
  margin-top:10px;padding:12px 16px;width:100%;
  background:var(--accent);border:none;color:#fff;
  font-weight:600;border-radius:8px;cursor:pointer;
}
button.action:hover{filter:brightness(1.1)}
.delete{background:#e74c3c}

/* BADGES */
.badge{
  padding:5px 10px;border-radius:6px;font-size:.8rem;font-weight:600;
  display:inline-block;margin-top:3px;
}
.ha{background:#ff3b3b33;border:1px solid #ff3b3b;color:#ff9a9a}
.ia{background:#b83bff33;border:1px solid #b83bff;color:#e6cbff}
.admin{background:#00c8ff33;border:1px solid #00c8ff;color:#c9f3ff}
.jadmin{background:#00ffe533;border:1px solid #00ffe5;color:#c9fff9}
.sstaff{background:#ffc40033;border:1px solid #ffc400;color:#fff0b6}
.staff{background:#00ff6033;border:1px solid #00ff60;color:#c6ffc6}
.sit{background:#4ea3ff33;border:1px solid #4ea3ff;color:#d7e8ff}
.civ{background:#ffffff22;border:1px solid #fff;color:#fff}

footer{text-align:center;opacity:.55;margin-top:40px}
.toggle{
  cursor:pointer;font-weight:600;padding:6px 10px;border-radius:8px;
  border:1px solid rgba(255,255,255,.3);
  background:rgba(0,0,0,.35);
}
</style>
</head>
<body>

<nav>
  <div class="nav-left">
    <a href="index.html">Home</a>
    <a href="departments.html">Departments</a>
    <a href="rules.html">Rules</a>
    <a href="apply.html">Apply</a>
    <a href="forums.html">Forums</a>
    <a href="staff.html">Staff Panel</a>
  </div>
  <div class="nav-right">
    <span id="themeToggle" class="toggle">ðŸŒ— Theme</span>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</nav>

<main>
  <h1 id="username">Loading...</h1>
  <p class="sub" id="email"></p>
  <p id="roleBadge"></p>

  <!-- PROFILE PICTURE -->
  <div class="pfp-box">
    <img id="pfp" src="https://i.imgur.com/8eO8KZB.png" alt="Profile Picture">
    <div class="upload-box">
      <input class="upload-input" id="newPFP" placeholder="Image URL (PNG/JPG only)">
      <button class="upload-btn" onclick="updatePFP()">Save</button>
    </div>
    <p id="pfpMsg"></p>
  </div>

  <!-- IDENTIFIERS -->
  <div class="section">
    <h2>Your System Identifier</h2>
    <div class="card">
      <strong>HWID:</strong> <span id="hwid"></span><br>
      <strong>Last Login IP:</strong> <span id="lastIP"></span><br>
      <strong>Last Login:</strong> <span id="lastLogin"></span>
    </div>
  </div>

  <!-- APPLICATIONS -->
  <div class="section">
    <h2>Your Applications</h2>
    <h3 style="margin-top:10px">Pending</h3><div id="pendingList"></div>
    <h3>Accepted</h3><div id="acceptedList"></div>
    <h3>Denied</h3><div id="deniedList"></div>
  </div>

  <!-- PROFILE SETTINGS -->
  <div class="section">
    <h2>Profile Settings</h2>
    <div class="card">
      <label>Change Username</label>
      <input id="newUser" placeholder="New username">
      <button class="action" onclick="changeUsername()">Update Username</button>
      <p id="userMsg"></p>
    </div>
  </div>

  <!-- SECURITY -->
  <div class="section">
    <h2>Account Security</h2>
    <div class="card">
      <label>New Password</label>
      <input type="password" id="newPass">
      <label>Confirm Password</label>
      <input type="password" id="confirmPass">
      <div id="strength"></div>
      <button class="action" onclick="changePassword()">Update Password</button>
      <p id="msg"></p>
    </div>

    <div class="card">
      <h3>Session Management</h3>
      <button class="action" onclick="logoutAll()">Logout All Devices</button>
      <p id="sessMsg"></p>
    </div>

    <div class="card" style="border-color:#e74c3c">
      <h3 style="color:#e74c3c">Delete Account</h3>
      <p>This action is irreversible.</p>
      <button class="action delete" onclick="deleteAccount()">Delete My Account</button>
      <p id="deleteMsg"></p>
    </div>
  </div>

</main>

<footer>Â© 2025 Shore Roleplay</footer>

<script>
const API="https://shoreroleplay.onrender.com";
const user=JSON.parse(localStorage.getItem("shoreUser"));
if(!user) location.href="login.html";

/* INIT */
document.getElementById("username").textContent=user.username;
document.getElementById("email").textContent=user.email;
renderRole();
loadIdentifiers();
loadApps();
loadPFP();

/* LOAD PROFILE PICTURE */
async function loadPFP(){
  const res=await fetch(API+"/users/"+user.id);
  const u=await res.json();
  document.getElementById("pfp").src=u.pfp||"https://i.imgur.com/8eO8KZB.png";
}

/* UPDATE PROFILE PICTURE */
async function updatePFP(){
  const url=document.getElementById("newPFP").value.trim();
  const msg=document.getElementById("pfpMsg");
  if(!url || !url.match(/^https?:\/\/.*\.(png|jpg|jpeg)$/i))
    return msg.textContent="Invalid image URL.";

  const r=await fetch(API+"/users/update-pfp",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({id:user.id,pfp:url})
  });

  if(r.ok){
    user.pfp=url;
    localStorage.setItem("shoreUser",JSON.stringify(user));
    document.getElementById("pfp").src=url;
    msg.style.color="#2ecc71";
    msg.textContent="Profile picture updated!";
  } else {
    msg.style.color="#e74c3c";
    msg.textContent="Update failed.";
  }
}

/* ROLE RENDER */
function renderRole(){
  const role=user.role||"Civilian";
  const roleMap={
    "Head Administrator":"ha",
    "Internal Affairs":"ia",
    "Administration":"admin",
    "Junior Administration":"jadmin",
    "Senior Staff":"sstaff",
    "Staff":"staff",
    "Staff In Training":"sit",
    "Civilian":"civ"
  };
  document.getElementById("roleBadge").innerHTML=
    `<span class="badge ${roleMap[role]||'civ'}">${role}</span>`;
}

/* IDENTIFIERS */
async function loadIdentifiers(){
  const res=await fetch(API+"/users/"+user.id);
  const u=await res.json();
  document.getElementById("hwid").textContent=u.hwid||"â€”";
  document.getElementById("lastIP").textContent=u.lastIP||"â€”";
  document.getElementById("lastLogin").textContent=u.lastLoginAt?new Date(u.lastLoginAt).toLocaleString():"â€”";
}

/* APPLICATIONS */
async function loadApps(){
  const res=await fetch(API+"/applications");
  const mine=(await res.json()).filter(a=>a.email===user.email);
  const out={pending:"pendingList",accepted:"acceptedList",denied:"deniedList"};
  mine.forEach(a=>{
    document.getElementById(out[a.status]).innerHTML+=
    `<div class="card"><strong>${a.department}</strong> â€” ${new Date(a.submittedAt).toLocaleString()}
     <span class="status-badge ${a.status}">${a.status.toUpperCase()}</span></div>`;
  });
}

/* THEME */
document.getElementById("themeToggle").onclick=()=>{
  document.body.dataset.theme=document.body.dataset.theme==="light"?"dark":"light";
};

/* USERNAME CHANGE */
async function changeUsername(){
  const v=document.getElementById("newUser").value.trim();
  const p=document.getElementById("userMsg");
  if(v.length<3) return p.textContent="Too short.";
  const r=await fetch(API+"/users/change-username",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({id:user.id,username:v})
  });
  if(r.ok){user.username=v;localStorage.setItem("shoreUser",JSON.stringify(user));p.textContent="Updated!";setTimeout(()=>location.reload(),900)}
}

/* PASSWORD CHANGE */
document.getElementById("newPass").oninput=e=>{
  const m=document.getElementById("strength"),l=e.target.value.length;
  m.textContent=l<6?"Weak":l<10?"Medium":"Strong";
  m.style.color=l<6?"#e74c3c":l<10?"#f1c40f":"#2ecc71";
};
async function changePassword(){
  const p=document.getElementById("newPass").value.trim();
  const c=document.getElementById("confirmPass").value.trim();
  const m=document.getElementById("msg");
  if(p!==c) return m.textContent="Does not match";
  const r=await fetch(API+"/users/update-password",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email:user.email,password:p})
  });
  m.textContent=r.ok?"Updated":"Failed";
}

/* LOGOUT ALL */
function logoutAll(){
  localStorage.removeItem("shoreUser");
  document.getElementById("sessMsg").textContent="All sessions cleared.";
  setTimeout(()=>location.href="index.html",1200);
}

/* DELETE ACCOUNT */
async function deleteAccount(){
  if(!confirm("Are you sure?"))return;
  const r=await fetch(API+"/users/"+user.id,{method:"DELETE"});
  const m=document.getElementById("deleteMsg");
  if(r.ok){localStorage.removeItem("shoreUser");m.textContent="Deleted";setTimeout(()=>location.href="index.html",900)}
}

/* LOGOUT BUTTON */
document.getElementById("logoutBtn").onclick=logoutAll;
</script>

</body>
</html>
