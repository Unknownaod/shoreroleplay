<!DOCTYPE html>
<html lang="en">
<head>
  <title>Shore Roleplay | Community Forums</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:"Inter",sans-serif;
  background:url("https://i.imgur.com/vbt5BPF.jpeg") center/cover fixed;
  color:#fff;overflow-x:hidden;
}

/* NAV */
nav{
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(18px);
  border-bottom:1px solid rgba(255,255,255,.12);
  padding:18px 60px;
  display:flex;justify-content:space-between;align-items:center;
  position:fixed;top:0;width:100%;z-index:50;
}
nav a{
  margin-right:26px;font-size:15px;color:#d0e2ff;
  text-decoration:none;transition:.25s;
}
nav a:hover{color:#4ea3ff}
#logoutBtn{
  background:#4ea3ff;padding:8px 16px;border-radius:7px;
  cursor:pointer;font-weight:600;box-shadow:0 0 14px #4ea3ff;
}

/* MAIN */
main{
  max-width:1200px;margin:140px auto 60px;padding:0 20px;
}
.section-title{font-size:2.3rem;margin-bottom:14px;font-weight:700}

/* CATEGORIES */
.category{
  background:rgba(0,0,0,.65);
  border:1px solid rgba(255,255,255,.12);
  padding:18px 24px;border-radius:12px;margin-bottom:14px;
  cursor:pointer;transition:.25s;
}
.category:hover{background:rgba(78,163,255,.18);border-color:#4ea3ff}
.category h3{font-size:1.3rem;font-weight:600}
.category p{opacity:.75;margin-top:6px;font-size:.9rem}

/* THREADS */
.thread{
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.12);
  padding:16px 20px;border-radius:10px;margin-bottom:10px;
  cursor:pointer;transition:.2s;
}
.thread:hover{background:rgba(255,255,255,.08)}
.thread .meta{opacity:.75;font-size:.8rem;margin-top:4px}
.staff-badge{
  padding:2px 8px;border-radius:6px;font-size:.75rem;
  margin-left:6px;font-weight:700;
}
.ha{background:#f1c40f;color:#000;}
.ia{background:#ff5050}
.adm{background:#3498db}
.jadm{background:#6741ff}
.sstaff{background:#ffaa00}
.staff{background:#27ae60}
.sit{background:#16a085}

/* POST BUTTON */
#createThreadBtn{
  background:#4ea3ff;padding:12px 20px;font-weight:600;
  border-radius:10px;font-size:15px;margin:18px 0;
  cursor:pointer;display:none;box-shadow:0 0 16px #4ea3ff;
}
#lockedMsg{
  display:none;background:rgba(255,0,0,.12);
  border:1px solid rgba(255,0,0,.3);
  padding:14px;border-radius:10px;margin:18px 0;
}

/* MODAL */
#modal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;
}
.modal-box{
  background:#0d1119;padding:28px;width:540px;border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
}
input,textarea{
  width:100%;padding:12px;border-radius:8px;margin-top:8px;
  border:1px solid rgba(255,255,255,.2);
  background:#111722;color:#fff;
}
textarea{height:140px;resize:none}
button{
  padding:12px 18px;border-radius:8px;border:none;
  margin-top:12px;font-weight:600;cursor:pointer;
}
.btn-primary{background:#4ea3ff}
.btn-close{background:#e74c3c}

footer{text-align:center;margin-top:40px;opacity:.45}
</style>
</head>
<body>

<nav>
  <div>
    <a href="index.html">Home</a>
    <a href="apply.html">Apply</a>
    <a href="forums.html" style="color:#4ea3ff">Forums</a>
  </div>
  <div id="logoutBtn">Logout</div>
</nav>

<main>
  <h1 class="section-title">Community Forums</h1>
  <p style="opacity:.75;margin-bottom:14px;">Discuss topics related to the Shore Roleplay community.</p>

  <!-- LOCKED IF NOT ACCEPTED -->
  <div id="lockedMsg">
    ðŸš« Posting is restricted. You must be part of a department with an <strong>accepted application</strong>.  
    <a href="apply.html" style="color:#4ea3ff">Apply here</a>.
  </div>

  <button id="createThreadBtn" onclick="openModal()">+ Start New Discussion</button>

  <!-- CATEGORIES -->
  <div class="category" onclick="loadThreads('general')">
    <h3>General Discussion</h3>
    <p>Talk about anything server-related.</p>
  </div>

  <div class="category" onclick="loadThreads('departments')">
    <h3>Departments</h3>
    <p>Inter-agency communication, SOP ideas & department news.</p>
  </div>

  <div class="category" onclick="loadThreads('technical')">
    <h3>Tech & Support</h3>
    <p>Bugs, suggestions, server systems, CAD support.</p>
  </div>

  <div id="threads"></div>
</main>

<!-- CREATE THREAD MODAL -->
<div id="modal">
  <div class="modal-box">
    <h2>Create New Thread</h2>
    <input id="threadTitle" placeholder="Thread Title">
    <textarea id="threadBody" placeholder="Write your message..."></textarea>
    <button class="btn-primary" onclick="createThread()">Post Thread</button>
    <button class="btn-close" onclick="closeModal()">Cancel</button>
  </div>
</div>

<footer>Â© Shore Roleplay 2025</footer>

<script>
const API = "https://shoreroleplay.onrender.com";
const user = JSON.parse(localStorage.getItem("shoreUser"));
if (!user) location.href = "login.html";

/* Logout */
document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("shoreUser");
  location.href = "index.html";
};

/* STAFF COLOR MAP */
const staffColors = {
  "Head Administrator": "ha",
  "Internal Affairs": "ia",
  "Administration": "adm",
  "Junior Administration": "jadm",
  "Senior Staff": "sstaff",
  "Staff": "staff",
  "Staff In Training": "sit"
};

/* PERMISSION CHECK */
async function verifyPermissions() {
  const apps = await fetch(API + "/applications").then(r => r.json());
  const accepted = apps.some(a => a.email.toLowerCase() === user.email.toLowerCase() && a.status === "accepted");

  if (accepted) document.getElementById("createThreadBtn").style.display = "block";
  else document.getElementById("lockedMsg").style.display = "block";
}
verifyPermissions();

/* LOAD THREADS */
async function loadThreads(category) {
  const container = document.getElementById("threads");
  container.innerHTML = "Loading threads...";

  const threads = await fetch(`${API}/threads/${category}`).then(r => r.json());

  if (threads.length === 0) {
    container.innerHTML = "<p style='opacity:.6;margin-top:10px'>No threads yet.</p>";
    return;
  }

  container.innerHTML = threads.map(t => `
    <div class="thread" onclick="viewThread('${t.id}')">
      <strong>${t.title}</strong>
      <div class="meta">by ${t.author.username}
        ${t.author.staffRole ? `<span class="staff-badge ${staffColors[t.author.staffRole]}">${t.author.staffRole}</span>` : ""}
        â€” ${new Date(t.createdAt).toLocaleDateString()}
      </div>
    </div>
  `).join("");
}

/* OPEN THREAD PAGE */
function viewThread(id) {
  location.href = `thread.html?id=${id}`;
}

/* MODAL OPEN/CLOSE */
function openModal(){ document.getElementById("modal").style.display="flex"; }
function closeModal(){ document.getElementById("modal").style.display="none"; }

/* CREATE THREAD */
async function createThread() {
  const title = threadTitle.value.trim();
  const body = threadBody.value.trim();
  if (title.length < 4 || body.length < 10) return alert("Thread content too short.");

  const res = await fetch(API + "/threads", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ title, body, category: currentCategory, userId: user.id })
  });

  if (res.ok) {
    alert("Thread posted!");
    closeModal();
    loadThreads(currentCategory);
  } else alert("Failed to post thread.");
}
</script>
</body>
</html>
